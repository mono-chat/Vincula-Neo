;;Socket updater by Sky;;

menu status {
  $iif(!$timer(checkpp),MassUpdate,$null) $+ :{
    .timertitle off
    unset %pp
    chkpassports 
  }
  $iif($timer(checkpp) > 0,Stop MassUpdate,$null) $+ :{ .timercheckpp off }
}

alias chkpassports {
  set %outputvar workingpassports $+ $ticks $+ .txt
  .timercheckpp -m 0 300 updatepp
}

alias updatepp {
  update $getnextpp
}

alias getnextpp {
  if (%pp == $lines(passports.txt)) { .timercheckpp off | titlebar Mass Update Complete: %worked | echo -a Notice:4 Mass update complete: %worked / %pp $calc(%worked / %pp * 100) $+ $chr(37) | halt }
  inc %pp
  return $read(passports.txt,%pp)
}

alias update {
  getinfo $1 $2
}

alias -l getinfo {
  var %sock = $+(update.,$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z))
  sockopen %sock msnialogin.passport.com 80
  sockmark %sock $iif(msn. isin $1,$1,$1 $+ @msn.com) $2
}

on *:sockopen:update.*:{
  sockwrite -n $sockname GET /login2.srf HTTP/1.1
  sockwrite -n $sockname Authorization: Passport1.4 OrgVerb=GET,OrgURL=?,sign-in= $+ $gettok($gettok($sock($sockname).mark,1,32),1,64) $+ $chr(37) $+ 40 $+ $gettok($gettok($sock($sockname).mark,1,32),2,64) $+ ,pwd= $+ $gettok($sock($sockname).mark,2,32) $+ ,id=507
  sockwrite -n $sockname Host: $+(msnialogin.passport.com,$crlf,$crlf)
}

on *:sockread:update.*:{
  var %data
  sockread %data
  tokenize 32 %data
  if (%data != $null) {
    if ($1 == Authentication-Info:) {
      inc %worked
      var %ticket $right($gettok($mid($3,$pos($3,'t=),$len($3)),1,38),-3)
      var %profile $right($gettok($gettok($mid($3,$pos($3,'t=),$len($3)),2,38),1,39),-2)
      render %ticket %profile %worked $sock($sockname).mark
    }
    elseif ($3 == Unauthorized) {
      echo -s Notice: 4Passport details incorrect. $sock($sockname).mark
      sockclose $sockname
    } 
  }
}

alias render {
  var %sock = $+(render.,$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z))
  sockopen %sock chat.msn.com 80
  sockmark %sock $1 $2 $3 $4-
}
on *:sockopen:render.*:{
  sockwrite -n $sockname GET /renderchat.msnw? HTTP/1.1
  sockwrite -n $sockname HOST: chat.msn.com
  sockwrite -n $sockname User-Agent: compatible; MSIE 4.0; Windows NT 4.0
  sockwrite -n $sockname Cookie: MSPAuth= $+ $gettok($sock($sockname).mark,1,32) $+ ; MSPProf= $+ $gettok($sock($sockname).mark,2,32) $+ $crlf $+ $crlf
}

on *:sockread:render.*:{
  sockread -n &read
  if ($sockbr == 0) { return }
  var %str = $bvar(&read,$bfind(&read, 1, 34 83 117 98 115 99 114 105 98 101 114 73 110 102 111 34),$bvar(&read,0)).text
  if (SubscriberInfo isin %str) { 
    var %w = $gettok($sock($sockname).mark,3,32)
    var %x = $mid(%str,$pos(%str,VALUE),$len(%str))
    %x = $mid(%x,$calc($pos(%x,") + 1),$len(%x))
    set %pauth. [ $+ [ %w ] ] $passform($gettok($sock($sockname).mark,1,32),$gettok($sock($sockname).mark,2,32))
    set %sinfo. [ $+ [ %w ] ] $mid(%x,1,$calc($pos(%x,") - 1))
    echo -s Notice: 4Passport $gettok($sock($sockname).mark,4,32) Succeeded in update.
    ;write %outputvar $gettok($sock($sockname).mark,4-,32)
    titlebar Socket Updates: %worked
  }
}
