;;;CORE CODE;;;

;Note, all DLL functions and parameters are case sensetive.

;Format

; $GKSSP(void).ircvers - A parameter is needed otherwise it will not work.
; $GKSSP(AuthType).init - A parameter is needed to distinguish the type of auth initiation (GateKeeper/GateKeeperPassport).
; $GKSSP(void).auths - A parameter is needed otherwise it will not work.
; $GKSSP(:GKSSP\0???\0\0\0?\0\0\0????????) - A parameter is needed to return a solution.


alias GKSSP {
  if (!$exists(GKSSP.dll)) { echo -a GateKeeper Security Service Package does not exist. | halt }
  if ($prop == ircvers) return $dll(GKSSP.dll,ircvers,)
  elseif ($prop == init) {
    if ($1 == guest) return $dll(GKSSP.dll,auth_init,gatekeeper)
    else return $dll(GKSSP.dll,auth_init,)
  }
  elseif ($prop == auths) return $dll(GKSSP.dll,auth_s,)
  elseif ($prop == challenge) return $dll(GKSSP.dll,challenge,$1)
}

alias __PPINIT return $+($GKSSP(passport).init,$lf,$GKSSP(void).ircvers,$lf)
alias __GKINIT return $+($GKSSP(guest).init,$lf,$GKSSP(void).ircvers,$lf)
alias __GKSSReply return $+($GKSSP(void).auths)
alias challenge_1 return $GKSSP($+($1,$2)).challenge

;GateKeeper Conversion (For generating guest gates)

alias gkssp_form {
  var %output,%hex,%x = $1,%i = 1
  ;seq=7,5,3,1,11,9,15,13,17
  if ($len($1) < 32) { %x = $+($str(0,$calc(32 - $len($ifmatch)),$ifmatch) }
  %x = $mid(%x,7,2) $+ $mid(%x,5,2) $+ $mid(%x,3,2) $+ $mid(%x,1,2) $+ $mid(%x,11,2) $+ $mid(%x,9,2) $+ $mid(%x,15,2) $+ $mid(%x,13,2) $+ $right(%x,-16)
  return $__tochr($__hexbin(%x,NULL))
}

alias __tochr {
  var %o,%i = 1
  while (%i <= $numtok($1-,32)) {
    %o = %o $+ $chr($gettok($1-,%i,32))
    inc %i
  }
  return %o
}

alias __hexbin { 
  var %o,%i = 1,%hex,%switch
  if (!$2) {
    ;Excluding Escape Char
    while (%i <= $len($1)) {
      %o = %o $base($mid($1,%i,2),16,10)
      inc %i 2
    }
    return %o
  }
  else {
    ;Including Escaps Char (0=00,t=09,n=0A,r=0D,b=20,c=2C,\=5C)
    while (%i <= $len($1)) {
      %switch = $mid($1,%i,2)
      if (%switch == 00) { %o = %o 92 48 }
      elseif (%switch == 09) { %o = %o 92 116 } 
      elseif (%switch == 0A) { %o = %o 92 110 } 
      elseif (%switch == 0D) { %o = %o 92 114 } 
      elseif (%switch == 20) { %o = %o 92 98 } 
      elseif (%switch == 2C) { %o = %o 92 99 } 
      elseif (%switch == 5C) { %o = %o 92 92 } 
      else { %o = %o $base(%switch,16,10) }
      inc %i 2
    }
    return %o
  }
}

alias binary { 
  var %binary
  var %i = 1
  while (%i <= 16) {
    %binary = $+(%binary,$iif($rand(1,0) == 0,\0,$chr(1)))
    inc %i
  }
  return %binary
}

alias guestform {
  return $mid($1,7,2) $+ $mid($1,5,2) $+ $mid($1,3,2) $+ $left($1,2) $+ $mid($1,11,2) $+ $mid($1,9,2) $+ $mid($1,15,2) $+ $mid($1,13,2) $+ $right($1,16)
}
alias passform return $base($len($$1),10,16,8) $+ $1 $+ $base($len($$2),10,16,8) $+ $2

alias getrndsck {
  return $+(advance.,$rand(A,Z),$rand(a,z),$rand(A,Z),$rand(a,z),$rand(A,Z),$rand(a,z),$rand(A,Z),$rand(a,z),$rand(A,Z),$rand(a,z),$1)
}

alias lookups {
  return 207.68.167.253
}

alias r exit | run $mircexe

alias xpt {
  echo @info  14,14 15,15 1,0 $+ $1-
}

on *:start:{
  dll titlebar.dll titlebar Xplore
  window -Sxk0ebl50 @info
  xpt Xplore - Non ocx Scanning tool by Sky.
  update
}

#guestmode on
#guestmode end

alias establish {
  xpt Setting up connections...
  var %chanx = 157,158,159,160,161,162
  var %x = 1
  sockclose tk2*
  while (%x <= $numtok(%chanx,44)) {
    sockopen $+(TK2CHATCHATA0,%x) $+(207.68.167.,$gettok(%chanx,%x,44)) 6667
    inc %x
  }
  sockopen TK2CHATCHATA09 207.68.167.165 6667
  sockopen TK2CHATCHATA10 207.68.167.166 6667
}

alias sr {
  ;echo -s $2-
  sockwrite -tn $1 $2-
}

on *:sockopen:TK*:{
  .timerkeepfinds $+ $sockname 0 15 keepfinds $sockname $sock($sockname).ip $sock($sockname).port $sock($sockname).mark
  if ($group(#guestmode) == on) {
    sockwrite -tn $sockname NICK >Xplore
    sockwrite $sockname $__GKINIT
  }
  else {
    sockwrite -tn $sockname NICK Xplore
    sockwrite $sockname $__PPINIT
  }
}

alias keepfinds {
  if ($sock($1).status == active) {
    sockwrite -tn $1 VERSION
  }
  else {
    sockopen $1 $2 $3
    sockmark $1 $4
  }
}

alias ConvertLanguage {
  if ($1 == 1) { return English }
  if ($1 == 2) { return French }
  if ($1 == 3) { return German }
  if ($1 == 4) { return Japanese }
  if ($1 == 5) { return Swedish }
  if ($1 == 6) { return Dutch }
  if ($1 == 7)  { return Korean }
  if ($1 == 9) { return Portuguese }
  if ($1 == 10) { return Finnish }
  if ($1 == 11) { return Danish }
  if ($1 == 12) { return Russian }
  if ($1 == 13) { return Italian }
  if ($1 == 14) { return Norwegian }
  if ($1 == 8) { return Chinese }
  if ($1 == 16) { return Spanish }
  if ($1 == 17) { return Czech }
  if ($1 == 18) { return Greek }
  if ($1 == 19) { return Hungarian }
  if ($1 == 20) { return Polish }
  if ($1 == 21) { return Slovene }
  if ($1 == 22) { return Turkish }
  if ($1 == 23) { return Slovak }
  if ($1 == 24) { return Portuguese }
}

on *:sockread:TK*:{
  var %data
  sockread %data
  tokenize 32 %data 
  ;echo -a $1-
  if ($1 == AUTH) {
    if ($3 == S) && ($4 != :OK) { 
      sockwrite $sockname $+($__GKSSReply,$challenge_1($4 $+ $sock($sockname).ip),$binary,$lf)
    }
    elseif ($4 == :OK) { sockwrite $sockname $+(AUTH $2 S %pauth,$lf) }
    elseif ($3 == *) { sockwrite -tn $sockname USER $me "Sky" "127.0.0.1" :Xplore by Sky }
  }
  elseif ($2 == 001) && ($right($sockname,1) == 6) {
    xpt Connections complete. Ready to scan... ( $+ $iif($group(#guestmode) == on,Guest,Passport) $+ )
  }
  if ($2 == 352) && ($dialog($right($4,-1))) {
    if ($remove($9,H,U,G) $+ $msn.decode($8) != $null) {
      if (!$dialog($8)) {
        var %dlg = $right($4,-1))
        did -a %dlg 2 $remove($9,H,U,G) $+ $msn.decode($8)
        did -ra %dlg 1 Users: $did(%dlg,2).lines
      }
    }
    hadd -m $msn.decode($8) Address $replace($5-6,$chr(32),@)
    hadd -m $msn.decode($8) Nick $8
    hadd -m $msn.decode($8) Tag $iif($11- == $null,None,$11-)
    if ($dialog($8)) {
      did -r $8 7 
      did -a $8 7 Nickname: $8
      did -a $8 7 GUID: $replace($5-6,$chr(32),@)
      did -a $8 7 Tag: $iif($11- == $null,None,$11-)
    }
  }
  elseif ($2 == 352) && ($dialog($8)) {
    if ($4 != *) {
      did -a $8 9 $4
    }
  }
  if ($2 == 818) && ($dialog($right($4,-1))) {
    if ($5 == Creation) {
      did -a $right($4,-1)) 5 $5 $+ : $date($mid($6,2),dd/mm/yyyy) at $time($mid($6,2),hh:nn:ss)
    }
    elseif ($5 == Language) { did -a $right($4,-1)) 5 $5 $+ : $ConvertLanguage($remove($6,:)) }
    else {
      did -a $right($4,-1)) 5 $5 $+ : $remove($6-,:)
    }
  }
  if ($2 == 324) && ($dialog($right($4,-1))) {
    did -r $right($4,-1)) 4
    did -a $right($4,-1)) 4 Modes: $5-
  }
}

on *:dialog:*#*:dclick:5:{
  clipboard $did($dname,5).seltext
}

on *:dialog:*#*:dclick:2:{
  var %nick = $remove($did($dname,2).seltext,.,@,+)
  %nick = $hget(%nick,Nick)
  var %tag = $hget(%nick,Tag)
  var %address = $hget(%nick,Address)
  createuser %nick
  sockwrite -tn TK* WHOIS %nick
  sockwrite -tn TK* WHO %nick
}

menu @info {
  Scan:{ scan }
  $iif($sline(@info,1) != $null,Get Information,$null) $+ :{ xpt Getting information for the channel | xpt $sline(@info,1) | getinfo $sline(@info,1) } 
  - 
  Copy:{ clipboard $sline(@info,1) }
  -
  Mode
  .Guest:{ .enable #guestmode | establish }
  .Passport:{ .disable #guestmode | establish }
}

alias getinfo {
  createdialog $1
  sockwrite -tn TK* MODE $1
  sockwrite -tn TK* PROP $1 *
  sockwrite -tn TK* WHO $1
}

alias scan {
  xpt Scanning...
  xml CP
  xml GE
  xml EA
  xml HE
  xml II
  xml LF
  xml MU
  xml NW
  xml PR
  xml RL
  xml RM
  xml SP
  xml TN
  xml PT
  xml AC
  xml EV
}

alias xmlhash return xml. $+ $rand(a,z) $+ $rand(a,z) $+ $rand(a,z) $+ $rand(a,z) $+ $rand(a,z)

alias xml {
  var %x = $xmlhash
  sockopen %x chat.msn.com 80
  sockmark %x $1
}

on *:SOCKOPEN:xml.*:{
  sockwrite -tn $sockname GET /en-us/ChatFind/Set1/ $+ $sock($sockname).mark $+ /roomlist.xml $+ $crlf $+ Host: chat.msn.com $+ $crlf $+ $crlf
}

on *:SOCKREAD:xml.*:{
  sockread -n &read
  if ($bvar(&read,0) > 0) breplace &read 0 10
  var %x = $bvar(&read,1,$iif($bvar(&read,0) < 900,$bvar(&read,0),900)).text
  %x = $replace(%x,$chr(10),) 
  if ($gettok(%x,1,32) == <channel) {  
    ;var %utf8 = $dll(utf8.dll,decode,$gettok(%x,2,34))
    var %room = $+($chr(37),$chr(35),$replace($gettok(%x,2,34),$chr(32),\b,&apos;,',&,â™¥,$chr(44),\c))
    var %topic = $gettok(%x,4,34)
    var %mode = $gettok(%x,6,34)
    var %managed = $gettok(%x,8,34)
    var %locale = $gettok(%x,10,34)
    var %language = $gettok(%x,12,34)
    var %currentusers = $gettok(%x,14,34)
    var %maxusers = $gettok(%x,16,34)
    if ($hget(Room,%room) == $null) {
      aline -pl @info %room
      dll titlebar.dll titlebar Xplore - $line(@info,0,1) Channels.
      hadd -m Room %room %locale
    }
  }
}


dialog room {
  title ""
  size -1 -1 253 147
  option dbu
  box "Users:", 1, 161 1 92 145
  list 2, 163 8 86 134, (hsbar, sort, size)
  box "Properties:", 3, 1 1 158 145
  text "Modes:", 4, 5 10 145 8
  list 5, 5 19 146 109, (hsbar, sort, size)
  button "OK", 6, 5 131 37 12, ok
  button "Refresh", 7, 115 131 37 12
}

on *:DIALOG:*#*:sclick:7:{
  did -r $dname 4
  did -r $dname 5
  did -r $dname 2
  did -r $dname 1
  var %room = $chr(37) $+ $dname
  sockwrite -tn TK* MODE %room
  sockwrite -tn TK* PROP %room *
  sockwrite -tn TK* WHO %room
}

dialog User {
  title ""
  size -1 -1 176 113
  option dbu
  box "Rooms:", 6, 1 47 174 52
  list 7, 4 7 169 37, size
  button "OK", 8, 1 100 37 12, ok
  list 9, 4 54 168 41, size
  box "Properties:", 10, 0 0 176 46
}

on *:dialog:*:dclick:9:{
  getinfo $$did($dname,9).seltext
}

on *:dialog:*:sclick:7:{
  clipboard $did($dname,7).seltext
}

alias createdialog {
  if ($dialog($right($1,-1))) { dialog -v $right($1,-1) | halt }
  dialog -m $right($1,-1) room
}

alias createuser {
  if ($dialog($1)) { dialog -v $1 | halt }
  dialog -m $1 user
  dialog -t $1 $msn.decode($1)
}

on *:dialog:*#*:init:0:{
  dialog -t $dname Information for $chr(37) $+ $dname
}
alias -l msn.decode {
  var %r, %l 1
  %r = $replace($1-,ï‚,B,ï‚ ,-,ï€>,-,ï€‹,-,ï€,-,ï…,E,ïƒ,C,ï,A,ï’,R,ï‹,K,ï¹,y,ïº˜,i,ïº‰,s,ï¬³,t,ï¬¸,u,ï»‰,e,ï«,k,ï†,F,ïµ,u,ï§,g,Î§,X,ï€¾,>,ï€¥,$chr(37),ï€¸,8,ï¤,d,ï­,m,ï¨,h,ï»›,s,ï‡,G,ï,M,ï¬,l,ï³,s,ïŸ,_,ï”,T,ï²,r,ï¡,a,ï®,n,ï£,c,ï¥,e,ï,N,ï¡,a,ï´,t,ï©,i,ï¯,o,ï®,n,ï¦,f,ï·,w,ïœ,\,ï¼,|,ï€,@,ï,P,ï„,D,ï€§,',ï€ , ,ï€¨,$chr(40),ï€©,$chr(41),ï€ª,*,ï€º,:,ï›,[,ï,],ï°,p,ï€®,.)
  %r = $replace(%r,Ï‡,X,Å†,n,Î©,n,»·,y,Ñ€,p,Ğ ,P,Å™,r,Ñ…,x,Ä®,I,Ä»,L,Ğ¤,o,Äˆ,C,Å,o,Å©,u,Å„,n,Ä¢,G,Å•,r,Å›,s,Ä·,k,Å–,R,×–,i,Îµ,e,×§,r,Ñ›,h,Ğ¼,m,ØŒ,·,Ä«,i,â€˜,‘,â€™,’,Û±,',Ä“,e,Â¢,¢,ï“,S,â€¢,•,ï,O,ï‰,I,Î†,A,ÑŠ,b,ŠÏ,T,Î¦,o,Ğ‚,b,Ñ,r,Ğ,E,Ğ´,A,Ğš,K,Ä,D,Ğ¸,n,Î¸,o,Ğœ,M,Ğ‡,I,Ğ¢,T,Ğ„,e,Çº,A,Ã¶,ö,Ã¤,ä,â€“,–,Â·,·,Ã–,Ö,Ãœ,Ü,Ã‹,Ë,Ñ•,s,Ä…,a,Ä­,i,Ğ¹,n,Ğ²,b,Ğ¾,o,Ñˆ,w,Ä,G,Ä‘,d,Ğ·,e,Å¦,T,Î±,a,ÄŸ,g,Ãº,ú,Å”,R,Ä„,A,Ä‡,c,Ä,Ğ,Îš,K,Ñ,y,Âµ,µ,Ã,Í,â€¹,‹,Â¦,¦,Ã•,Õ,Ã™,Ù,Ã€,À,Î ,N,Ò“,f,Î°,u,Ä¿,L,Å,o,Ï‚,c,Ä‹,c,Ä§,h,Ä¯,i,Å§,t,Î–,Z,Ã,Ş,Ã¾,ş,Ã§,ç,Ã¡,á,Â¾,¾,Å¾,,Ã‡,Ç,Â $+ $chr(173),-,Ã,Á,â€¦,…,Â¨,¨,Ã½,ı,Ë‰,¯,â€,”,Ã›,Û,Ã¬,ì,Ï,p,Î­,e,Ğ³,r,Ã ,à,Ãˆ,È,Â¼,¼,Äµ,j,Ã£,ã,Ä™,e,ÅŸ,s,Âº,º,Ã‘,Ñ,Ã£,ã,Ã†,Æ,Ëš,°,Ğ¯,R,Ëœ,˜,Ã,Î,ÃŠ,Ê,Ã,İ,Ã,Ï,Ã‰,É,â€¡,‡,ÃŒ,Ì,Âª,ª,Ã³,ó,â„¢,™,Ã’,Ò,Ã­,í,Â¿,¿,Ã„,Ä,Â¶,¶,Ã¼,ü,Æ’,ƒ,Ã°,ğ,Ã²,ò,Ãµ,õ,Â¡,¡,Ã©,é,ÃŸ,ß,Â¤,¤,Ã—,×,Ã´,ô,Å ,Š,Ã¸,ø,â€º,›,Ã¢,â,Ã®,î,â‚¬,€,Å¡,š,Ã¯,ï,Ã¿,ÿ,Åƒ,N,Â©,©,Â®,®,Ã»,û,â€ ,†,Â°,°,Â§,§,Â±,±,Â²,²,Ã¨,è)
  %r = $replace(%r,Å‡,N,Û°,·,Ä´,J,Ğ†,I,Î£,E,Î¹,i,Å,O,Î´,o,×¥,y,Î½,v,×¢,y,×,n,Å½,,Å‘,o,ÄŒ,C,Ä—,e,â‚¤,L,ÅŒ,O,Î¬,a,Ä ,G,â„¦,O,Ğ,H,á»ƒ,e,áºµ,a,Ğ–,K,á»,e,áº¿,e,á»—,o,Å«,u,â‚£,F,âˆ†,a,áº®,A,á»§,u,Ä¶,K,Å¤,T,Å,S,Î˜,O,Ğ¨,W,Î’,B,ĞŸ,N,áº…,w,ï»¨,i,ï¯¼,s,ÑŸ,u,Ñ’,h,Â¹,¹,á»²,Y,Î»,a,Ğ¡,C,Ğ $+ $chr(173),E,Å°,U,Äª,I,Ä,c,Ä”,E,Åœ,S,á»Š,I,Ä,g,Å€,l,Ñ—,i,Ù­,*,Å‰,n,Ä¦,H,Ğ”,A,Îœ,M,Ñ‘,e,Ğ¦,U,Ñ,e,â€œ,“,Ñ„,o,Ñƒ,y,Ñ,c,Ğº,k,Ã…,Å,Æ¤,P,â„,R,ï “,I,É³,n,Ê—,c,â–«,·,Ñ“,r,á»‡,e,áº¯,a,áº³,a,Å¯,u,Ä½,L,Æ°,u,Î‡,·,Ë™,',Î·,n,â„“,l,Â,,Â,,Â,,×€,i,Ä¡,g,Å´,W,Î”,A,ï®Š,J,Î¼,µ,Å¸,Ÿ,Ä¥,h,Î²,ß,Ğ¬,b,Å³,u,Ñ”,e,Ï‰,w,ÄŠ,C,Ñ–,i,Å‚,l,Ç¿,o,âˆ«,s,Å¼,z,Å£,t,Ã¦,æ,â‰ˆ,=,Å,L,Å‹,n,Ú¯,S,Ä,d,Ïˆ,w,Ïƒ,o,Ä£,g,Î‰,H,Î,i,Ò‘,r,Îº,k,ÅŠ,N,œ,\,ï€¯,/,Â¬,¬,Ñ‰,w,Û•,o,×,o,Â³,³,Â½,½,Ä°,I,Ä¾,l,Ä•,e,Å¢,T,Å,s,Å·,y,Ä¾,l,Ä©,i,Ã”,Ô,Åš,S,Ä¹,L,Ğ°,a,Ğµ,e,Î¡,P,Ğˆ,J,Î,N,Ç»,a,Ñ’,h,Î®,n,Î¯,l,Å’,Œ,Â¯,¯,Ä,a,Åµ,w,Ã‚,Â,Ãƒ,Ã,Ğ½,H,Ë‡,',Â¸,¸,Ì£,$chr(44),Ø·,b,Ã“,Ó,Ğ™,N,Â«,«,Ã¹,ù,Ã˜,Ø,Ãª,ê)
  %r = $replace(%r,Ø§,I,Ğ»,n,Ñ‹,bl,Ğ±,6,×©,w,â€•,-,Îª,I,ï ,`,Å­,u,á»•,o,Ç¾,Ø,áº«,a,áº§,a,ï±,q,áº‚,W,Ä¤,H,á»,o,âˆ’,-,ï,^,à¸¥,a,Äœ,G,ïº¯,j,Ù‰,s,Ğƒ,r,á»©,u,â—,·,Ï,u,ï€°,0,ï€·,7,ï€¢,",Ó©,O,Ç,i,Ç‘,O,Æ ,O,ï€²,2,Ò¯,y,ï¶,v,Ğ,A,â‰¤,<,â‰¥,>,áº©,a,ïˆ,H,Ù¤,e,ïº‚,i,ĞŒ,K,Åª,U,ï€»,;,Äƒ,a,Ä¸,k,Ä†,C,Ä¬,I,Åˆ,n,Ä¨,I,Î™,I,Î«,Y,ïŠ,J,ï˜,X,ï½,$chr(125),ï»,$chr(123),Î,E,Ë†,^,ï–,V,ïŒ,L,Î³,y,ïº,i,Î,o,á»³,y,Ä†,C,Ä¬,I,Ä¸,k,Å¶,y,à¹›,c,á»¡,o,à¹“,m,ïº„,i,ï­,G,Å¬,U,Ä’,E,Ä‚,A,Ã·,÷,Â , ,â€š,‚,â€,„,Ë†,ˆ,â€°,‰,Äƒ,a,ï¸,x,ï€½,=,Ù‚,J,ï€¿,?,ï¿¼,-,â—Š,o,Ñ‚,T,Ä€,A,ï­‡,P,Ä–,E,Ä˜,E,Î¿,o,Ï‹,u,â€¼,!!,×˜,u,ï®’,S,Ğ§,y,Ò,r,Ä›,e,Ä˜,E,Äº,I,Î›,a,Î¿,o,Ãš,Ú,Å˜,R,Æ¯,U,Å“,œ,ï€­,-,â€”,—,à¸«,n,à¸ª,a,à¸,s,Î¨,Y,áºª,A,Ï€,n,Å…,N,Ø!,o,Ğ‹,h,á»£,o,Ä‰,c,â—¦,·,ï®,S,Å²,U,Ğ•,E,Ğ…,S,Ûµ,o,ÙŠ,S,Ø¨,u,Ø©,o,Ø¦,s,Ä¼,l,Ä±,i,Å—,r,Ğ¶,x,Î…,",Ï,w,â–ª,·,Î¶,l,Ğ©,W,à¸¿,B,á»¹,y,ÏŠ,i,Å¥,t,Ğ¿,n,Â´,´,Ú©,s,ï±¢,*,Î¾,E,Ñœ,k,âˆš,v,Ï„,t,Ã,Ğ,Â£,£,Ã±,ñ,Â¥,¥,Ã«,ë,Ã¥,å,ï™,Y,Ç,a)
  %r = $replace(%r,áº±,a,â€‚, ,ÎŸ,O,â‚ª,n,áº¬,A,ï‚£,£,ïƒ ,à,ï‚®,®,ïƒ¡,á,ï‚©,©,ïƒµ,õ,á»,o,â€, ,Ö±,¸,Ö¾,-,ï¬´,n,Åº,z,â€Œ, ,Ù,',à¹˜,c,à¸…,m,Â,,ï€¼,<,â–¼,v,ï»œ,S,â„®,e,Åº,z,áº­,a,à¹‘,a,ï¬,fi,ÑŒ,b,ïº’,.,ïºœ,:,à¸¨,a,à¸ ,n,à¹,o,à¸°,=,ï­†,y,à¸‹,i,â€¾,¯,âˆ‚,a,ï¼š,:,â‰ ,=,ï€«,+,Ù…,r,á»“,o,á»¬,U,Ğ›,N,Ó’,A,á»Œ,O,áº„,W,á»´,Y,ïºš,u,ïº¬,i,ïº,u,Å»,Z,ï®•,S,ïº³,w,ï¯½,u,ïº±,uw,ï»š,J,ïº”,a,ï€¡,!,á»…,e,Ù„,J,Ø±,j,Ù€,_,ÏŒ,o,â‚«,d,â„–,no,á»¯,u,Äš,E,Ï†,o,ï» ,I,Ñ†,u,ïƒ…,A,ïƒ‘,N,ĞŠ,H,Îˆ,E,ï¾,~,ï•,U,áº¡,a,ï€±,1,ï€´,4,ï€³,3,á»‰,i,Î•,E,Ğ,U,Ùƒ,J,â˜…,*,ï¢,b,ï€£,$chr(35),ï€¤,$,â—‹,o,Ñ,10,á»µ,y,áº,w,Ò›,k,Ù¿,u,â™‚,o,ï­Š,n,Ù¥,o,ï®,S,â¿,n,ï»—,9,ï¢,b,ï€£,$chr(35),ï€¤,$,â—‹,o,Ñ,10,á»‹,i,Î‘,A,â€€, ,ï»©,o,ï»,E,Ù†,u,áº½,e,Ø«,u,ã…“,t,Ó›,e,Ó˜,E,ï»˜,o,Û·,v,ï¬ª,w,á»¥,u,Å,O,Â,,á»±,u,ï¼ª,J,ï½…,e,ï½,a,ï¼®,N,ï¼ˆ,$chr(40),ï¼ ,@,ï½€,`,ï¼,.,â€²,',ï¼‰,$chr(41),â–¬,-,â—„,<,â–º,>,âˆ‘,E,Ö»,$chr(44),â€¬,|,â€,|,â€ª,|,â€«,|,á»˜,O,Ğ˜,N,ï—,W,ïº,z)
  %r = $replace(%r,×¡,o,â•³,X,Ù ,·,Ò’,F,Ï…,u,â€,,Ö¼,·,Ç”,u,à¸œ,w,áº°,A,áº¤,A,Â»,»,ïº–,u,á»‘,o,ï®“,S,á»Ÿ,o,ïº•,u,ï®”,S, Òœ,K,â™¦,·,â€—,_,ï»ˆ,b,à¸¬,w,ï¬°,x,ï‚­,-,à¸‚,u,à¸—,n,á»œ,O,áº¶,A,á»­,u,á»„,E,à¨¹,J, Ù‡,o,â– ,·,Æ¡,o,ï¿,,Ò£,h,Òš,K,Ò²,X,Ò³,x,Òœ,K,Ø¹,E,Ú†,c,Ñ‡,y,Ğ¥,X,Ù¦,7,Ö½,.,Ù,',Ö¿,',×ƒ,:,á»,o,Ò–,X,ÛŒ,s,à¸¬,w,âˆ™,·,Î¤,T,â“’,c,â“,a,â“Ÿ,p,â“”,e,â“£,t,Ç,A,Ğ¥,X,Ö³,.,ÛŒ,s,á»ˆ,I,Ì‰,',ïš,Z,á»,o,áº¹,e,Ò,k,ïº–,u,á»‘,o,ï®“,S,á»Ÿ,o,ïº•,u,Òš,K,ïš,Z,Ì•,',â”œ,|,â”¤,|,Ø£,I,Â‹,,×,x,áº·,a,Ç’,o,á»œ,O,â˜¼,¤,×,.,ïš,Z,à¸¤,n,â‘·,4,â‘µ,2,â’ª,0,à¹€,i)
  return %r
}
alias passform return $base($len($$1),10,16,8) $+ $1 $+ $base($len($$2),10,16,8) $+ $2

alias update {
  if (!%account) { set %account $$?"Please enter in your email." }
  if (!%password) { set %password $$?"Please enter in your password." }
  ginfo %account %password
  set %udticks $ticks
}

alias -l ginfo {
  sockclose update
  if ($gettok(%account,2,64) == msn.com) {
    sockopen update msnialogin.passport.com 80
    sockmark update $1 $2 msnialogin.passport.com
  }
  elseif ($gettok(%account,2,64) == hotmail.com) {
    sockopen update loginnet.passport.com 80
    sockmark update $1 $2 loginnet.passport.com
  }
  else {
    sockopen update login.passport.com 80
    sockmark update $1 $2 login.passport.com
  }
}

on *:sockopen:update:{
  sockwrite -n $sockname GET /login2.srf HTTP/1.1
  sockwrite -n $sockname Authorization: Passport1.4 OrgVerb=GET,OrgURL=?,sign-in= $+ $gettok($gettok($sock($sockname).mark,1,32),1,64) $+ $chr(37) $+ 40 $+ $gettok($gettok($sock($sockname).mark,1,32),2,64) $+ ,pwd= $+ $gettok($sock($sockname).mark,2,32) $+ ,id=507
  sockwrite -n $sockname Host: $+($gettok($sock($sockname).mark,3,32),$crlf,$crlf)
}

alias chkg {
  if ($group(#guestmode) == on) {
    var %q = Guest mode is currently turned on, would you like to enable Passport mode?
    var %x = $input(%q,y)
    if (%x == $true) {
      .disable #guestmode
    }
  }
  establish
}

on *:sockread:update:{
  var %data
  sockread %data
  tokenize 32 %data
  if (%data != $null) {
    if ($1 == Authentication-Info:) {
      set %ticket $right($gettok($mid($3,$pos($3,'t=),$len($3)),1,38),-3)
      set %profile $right($gettok($gettok($mid($3,$pos($3,'t=),$len($3)),2,38),1,39),-2)
      set %pauth : $+ $passform(%ticket,%profile)
      xpt 9Passport updated.
      if (%runonce == $null) { .timerfehughsr 1 0 chkg | set %runonce true }
      else { establish }
    }
    elseif ($3 == Unauthorized) {
      xpt 4Passport details incorrect.
      sockclose $sockname
    } 
  }
}
