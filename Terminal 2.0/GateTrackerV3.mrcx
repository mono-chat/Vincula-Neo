/*

Nickname logger and Gate Tracking system design by Sky
GateTracker V3
Specially designed for brimari

*/

//Hotlinks

on ^*:HOTLINK:*@*:*:{
  if ($1) return
}
on *:HOTLINK:*@*:*:{
  set -u1 %requestedtrack $remove($iif(! isin $1,$gettok($1,2,33),$1),$chr(36),*)
  inittracker
}

//Events

on *:JOIN:#:{
  if ($nick == $me) { halt }
  ;Log
  if (%namesflood. [ $+ [ # ] ] != true) { set -u1 %namesflood. [ $+ [ # ] ] true }
  else { halt }


  ;Log Nickname

  if (!$get_addy($nick)) {
    write -l [ $+ [ $calc($lines($geta_source()) +1) ] ] $geta_source() $nick $+ = $+ $ial($nick).addr
  }

  ;Log Address
  if ($exists($get_source)) {
    var %x = $get_line($ial($nick).user)
    ;echo -a test %x $ial($nick).user
    if (%x != $null) {
      var %y = $gettok(%x,2,61)
      if ($findtok(%y,$nick,0,44) == 0) { %y = %y $+ $nick $+ , | write -al [ $+ [ $readn ] ] $get_source() $nick $+ , }
    }
    else {
      write -l [ $+ [ $calc($lines($get_source()) +1) ] ] $get_source() $ial($nick).addr $+ = $+ $nick $+ ,
    }
  }
  else {
    write -l1 $get_source() $ial($nick).addr $+ = $+ $nick $+ ,
  }

  ;Echo/Message

  if (%y != $null) {
    ;Set Values

    var %a = $calc($numtok(%y,44) - 4)
    if (%a <= 0) { %a = 1 }
    var %b = $numtok(%y,44)

    ;Truncate
    %y = $gettok(%y,$+(%a,-,%b),44)

    ;Reverse if needed
    if ($reverse_nickname() == on) {
      %y = $reverseNick(%y)
    }

    ;Strip Nickname
    %y = $filter_nick($nick,%y)
    if ($left(%y,1) == ,) { %y = $right(%y,-1) }
    if ($right(%y,1) == ,) { %y = $left(%y,-1) }

    ;if only the nick or nothing then halt
    if (%y == $nick || %y == $null) { halt }

    ;Encode if needed
    if ($encoded_string() == on) { %y = $msn.decode(%y) }

    ;Present in either MSG or ECHO
    if ($external_track() == on) {
      msg # 12Names ›7 $iif($encoded_string() == on,$msn.decode($nick),$nick) 12› $remtok(%y,$nick,1,44)
    }
    else {
      echo # 12Names ›7 $iif($encoded_string() == on,$msn.decode($nick),$nick) 12› $remtok(%y,$nick,1,44)
    }
  }
}

menu menubar {
  GateTrackerV3
  .Display
  ..Currently $iif($external_track() == on,Messaging,Echoing)
  ...Echo:{ .disable #extTrack }
  ...Msg:{ .enable #extTrack }
  .Text $iif($encoded_string() == on,Encoded,Decoded)
  ..Encode:{ .enable #encString }
  ..Decode:{ .disable #encString }
  .Order $iif($reverse_nickname() == on,Reversed,Normal)
  ..Normal:{ .disable #reverseNicknames }
  ..Reversed:{ .enable #reverseNicknames }
  .System:{ inittracker }
}


menu nicklist {
  $msn.decode($snicks)
  .System:{ set -u1 %requestedtrack $ial($snick(#,1)).addr | inittracker }
}


//Groups

#extTrack off
#extTrack end

#reverseNicknames off
#reverseNicknames end

#encString on
#encString end

alias reverse_nickname {
  return $group(#reverseNicknames)
}

alias encoded_string {
  return $group(#encString)
}

alias external_track {
  return $group(#extTrack)
}

alias reverseNick {
  var %o,%i = $numtok($1,44)
  while (%i >= 1) {
    %o = %o $+ $gettok($1,%i,44) $+ ,
    dec %i
  }
  return %o
}

alias trim {
  return $replace($1-,$chr(32),$null)
}

alias filter_nick {
  var %o,%i = 1
  while (%i <= $numtok($2-,44)) {
    if ($trim($1) != $trim($gettok($2-,%i,44))) {
      %o = %o $+ $gettok($2-,%i,44) $+ ,
    }
    inc %i
  }
  return %o
}

dialog GateTracker {
  title "Gate Tracker Version 2 by Sky"
  size -1 -1 213 112
  option dbu
  list 1, 0 1 213 98, size
  combo 2, 163 100 49 112, size drop
  edit "", 3, 0 100 161 11
  button "", 4, 5000 5000 1 1, default 
}


on *:dialog:GateTracker:init:*:{
  did -a GateTracker 2 Nickname
  did -a GateTracker 2 Address
  did -c GateTracker 2 1
  if (%requestedtrack) {
    did -a $dname 3 %requestedtrack
    did -c $dname 2 2
    showinfo
  }
}

on *:dialog:GateTracker:sclick:4:{
  showinfo
}


on *:dialog:GateTracker:sclick:1:{
  clipboard $did($dname,1).seltext
}

//Alias's

alias -l showinfo {
  did -r GateTracker 1
  if ($did(GateTracker,2).text == Address) {
    var %names = $get_names($did(GateTracker,3).text)
    if (%names == $null) { did -a GateTracker 1 Not found. }
    elseif (%names != $null) {
      if ($chr(44) isin %names) {
        var %i = 1
        while (%i <= $numtok(%names,44)) {
          did -a GateTracker 1 $gettok(%names,%i,44) $+ ! $+ $did(GateTracker,3).text
          inc %i
        }
      }
    }
  }
  elseif ($did(GateTracker,2).text == Nickname) {
    var %address = $get_addy($did(GateTracker,3).text)
    if (%address == $null) { did -a GateTracker 1 Not found. }
    elseif (%address != $null) { did -a GateTracker 1 $did(GateTracker,3).text $+ ! $+ %address }
  }
}

alias inittracker {
  if ($dialog(GateTracker)) { 
    dialog -v GateTracker
    if (%requestedtrack) {
      did -r GateTracker 3
      did -a GateTracker 3 %requestedtrack
      did -c GateTracker 2 2
      showinfo
    }
    halt 
  }
  dialog -m GateTracker GateTracker
}

alias get_line {
  ;Params = GUID@GateKeeperPassport
  return $right($read($get_source(),w,* $+ $gettok($1,1,64) $+ *),900)
}

alias get_names {
  ;Params = GUID@GateKeeperPassport
  return $right($gettok($read($get_source(),w,* $+ $gettok($1,1,64) $+ *),2,61),900)
}

alias get_addy {
  ;Params = Nickname
  return $right($gettok($read($geta_source(),w,* $+ $1 $+ *),2,61),900)
}

alias get_source {
  return Names.ini
}

alias geta_source {
  return Address.ini
}

alias -l msn.decode {
  var %r, %l 1
  %r = $replace($1-,ï‚,B,ï‚ ,-,ï€>,-,ï€‹,-,ï€,-,ï…,E,ïƒ,C,ï,A,ï’,R,ï‹,K,ï¹,y,ïº˜,i,ïº‰,s,ï¬³,t,ï¬¸,u,ï»‰,e,ï«,k,ï†,F,ïµ,u,ï§,g,Î§,X,ï€¾,>,ï€¥,$chr(37),ï€¸,8,ï¤,d,ï­,m,ï¨,h,ï»›,s,ï‡,G,ï,M,ï¬,l,ï³,s,ïŸ,_,ï”,T,ï²,r,ï¡,a,ï®,n,ï£,c,ï¥,e,ï,N,ï¡,a,ï´,t,ï©,i,ï¯,o,ï®,n,ï¦,f,ï·,w,ïœ,\,ï¼,|,ï€,@,ï,P,ï„,D,ï€§,',ï€ , ,ï€¨,$chr(40),ï€©,$chr(41),ï€ª,*,ï€º,:,ï›,[,ï,],ï°,p,ï€®,.)
  %r = $replace(%r,Ï‡,X,Å†,n,Î©,n,»·,y,Ñ€,p,Ğ ,P,Å™,r,Ñ…,x,Ä®,I,Ä»,L,Ğ¤,o,Äˆ,C,Å,o,Å©,u,Å„,n,Ä¢,G,Å•,r,Å›,s,Ä·,k,Å–,R,×–,i,Îµ,e,×§,r,Ñ›,h,Ğ¼,m,ØŒ,·,Ä«,i,â€˜,‘,â€™,’,Û±,',Ä“,e,Â¢,¢,ï“,S,â€¢,•,ï,O,ï‰,I,Î†,A,ÑŠ,b,ŠÏ,T,Î¦,o,Ğ‚,b,Ñ,r,Ğ,E,Ğ´,A,Ğš,K,Ä,D,Ğ¸,n,Î¸,o,Ğœ,M,Ğ‡,I,Ğ¢,T,Ğ„,e,Çº,A,Ã¶,ö,Ã¤,ä,â€“,–,Â·,·,Ã–,Ö,Ãœ,Ü,Ã‹,Ë,Ñ•,s,Ä…,a,Ä­,i,Ğ¹,n,Ğ²,b,Ğ¾,o,Ñˆ,w,Ä,G,Ä‘,d,Ğ·,e,Å¦,T,Î±,a,ÄŸ,g,Ãº,ú,Å”,R,Ä„,A,Ä‡,c,Ä,Ğ,Îš,K,Ñ,y,Âµ,µ,Ã,Í,â€¹,‹,Â¦,¦,Ã•,Õ,Ã™,Ù,Ã€,À,Î ,N,Ò“,f,Î°,u,Ä¿,L,Å,o,Ï‚,c,Ä‹,c,Ä§,h,Ä¯,i,Å§,t,Î–,Z,Ã,Ş,Ã¾,ş,Ã§,ç,Ã¡,á,Â¾,¾,Å¾,,Ã‡,Ç,Â $+ $chr(173),-,Ã,Á,â€¦,…,Â¨,¨,Ã½,ı,Ë‰,¯,â€,”,Ã›,Û,Ã¬,ì,Ï,p,Î­,e,Ğ³,r,Ã ,à,Ãˆ,È,Â¼,¼,Äµ,j,Ã£,ã,Ä™,e,ÅŸ,s,Âº,º,Ã‘,Ñ,Ã£,ã,Ã†,Æ,Ëš,°,Ğ¯,R,Ëœ,˜,Ã,Î,ÃŠ,Ê,Ã,İ,Ã,Ï,Ã‰,É,â€¡,‡,ÃŒ,Ì,Âª,ª,Ã³,ó,â„¢,™,Ã’,Ò,Ã­,í,Â¿,¿,Ã„,Ä,Â¶,¶,Ã¼,ü,Æ’,ƒ,Ã°,ğ,Ã²,ò,Ãµ,õ,Â¡,¡,Ã©,é,ÃŸ,ß,Â¤,¤,Ã—,×,Ã´,ô,Å ,Š,Ã¸,ø,â€º,›,Ã¢,â,Ã®,î,â‚¬,€,Å¡,š,Ã¯,ï,Ã¿,ÿ,Åƒ,N,Â©,©,Â®,®,Ã»,û,â€ ,†,Â°,°,Â§,§,Â±,±,Â²,²,Ã¨,è)
  %r = $replace(%r,Å‡,N,Û°,·,Ä´,J,Ğ†,I,Î£,E,Î¹,i,Å,O,Î´,o,×¥,y,Î½,v,×¢,y,×,n,Å½,,Å‘,o,ÄŒ,C,Ä—,e,â‚¤,L,ÅŒ,O,Î¬,a,Ä ,G,â„¦,O,Ğ,H,á»ƒ,e,áºµ,a,Ğ–,K,á»,e,áº¿,e,á»—,o,Å«,u,â‚£,F,âˆ†,a,áº®,A,á»§,u,Ä¶,K,Å¤,T,Å,S,Î˜,O,Ğ¨,W,Î’,B,ĞŸ,N,áº…,w,ï»¨,i,ï¯¼,s,ÑŸ,u,Ñ’,h,Â¹,¹,á»²,Y,Î»,a,Ğ¡,C,Ğ $+ $chr(173),E,Å°,U,Äª,I,Ä,c,Ä”,E,Åœ,S,á»Š,I,Ä,g,Å€,l,Ñ—,i,Ù­,*,Å‰,n,Ä¦,H,Ğ”,A,Îœ,M,Ñ‘,e,Ğ¦,U,Ñ,e,â€œ,“,Ñ„,o,Ñƒ,y,Ñ,c,Ğº,k,Ã…,Å,Æ¤,P,â„,R,ï “,I,É³,n,Ê—,c,â–«,·,Ñ“,r,á»‡,e,áº¯,a,áº³,a,Å¯,u,Ä½,L,Æ°,u,Î‡,·,Ë™,',Î·,n,â„“,l,Â,,Â,,Â,,×€,i,Ä¡,g,Å´,W,Î”,A,ï®Š,J,Î¼,µ,Å¸,Ÿ,Ä¥,h,Î²,ß,Ğ¬,b,Å³,u,Ñ”,e,Ï‰,w,ÄŠ,C,Ñ–,i,Å‚,l,Ç¿,o,âˆ«,s,Å¼,z,Å£,t,Ã¦,æ,â‰ˆ,=,Å,L,Å‹,n,Ú¯,S,Ä,d,Ïˆ,w,Ïƒ,o,Ä£,g,Î‰,H,Î,i,Ò‘,r,Îº,k,ÅŠ,N,œ,\,ï€¯,/,Â¬,¬,Ñ‰,w,Û•,o,×,o,Â³,³,Â½,½,Ä°,I,Ä¾,l,Ä•,e,Å¢,T,Å,s,Å·,y,Ä¾,l,Ä©,i,Ã”,Ô,Åš,S,Ä¹,L,Ğ°,a,Ğµ,e,Î¡,P,Ğˆ,J,Î,N,Ç»,a,Ñ’,h,Î®,n,Î¯,l,Å’,Œ,Â¯,¯,Ä,a,Åµ,w,Ã‚,Â,Ãƒ,Ã,Ğ½,H,Ë‡,',Â¸,¸,Ì£,$chr(44),Ø·,b,Ã“,Ó,Ğ™,N,Â«,«,Ã¹,ù,Ã˜,Ø,Ãª,ê)
  %r = $replace(%r,Ø§,I,Ğ»,n,Ñ‹,bl,Ğ±,6,×©,w,â€•,-,Îª,I,ï ,`,Å­,u,á»•,o,Ç¾,Ø,áº«,a,áº§,a,ï±,q,áº‚,W,Ä¤,H,á»,o,âˆ’,-,ï,^,à¸¥,a,Äœ,G,ïº¯,j,Ù‰,s,Ğƒ,r,á»©,u,â—,·,Ï,u,ï€°,0,ï€·,7,ï€¢,",Ó©,O,Ç,i,Ç‘,O,Æ ,O,ï€²,2,Ò¯,y,ï¶,v,Ğ,A,â‰¤,<,â‰¥,>,áº©,a,ïˆ,H,Ù¤,e,ïº‚,i,ĞŒ,K,Åª,U,ï€»,;,Äƒ,a,Ä¸,k,Ä†,C,Ä¬,I,Åˆ,n,Ä¨,I,Î™,I,Î«,Y,ïŠ,J,ï˜,X,ï½,$chr(125),ï»,$chr(123),Î,E,Ë†,^,ï–,V,ïŒ,L,Î³,y,ïº,i,Î,o,á»³,y,Ä†,C,Ä¬,I,Ä¸,k,Å¶,y,à¹›,c,á»¡,o,à¹“,m,ïº„,i,ï­,G,Å¬,U,Ä’,E,Ä‚,A,Ã·,÷,Â , ,â€š,‚,â€,„,Ë†,ˆ,â€°,‰,Äƒ,a,ï¸,x,ï€½,=,Ù‚,J,ï€¿,?,ï¿¼,-,â—Š,o,Ñ‚,T,Ä€,A,ï­‡,P,Ä–,E,Ä˜,E,Î¿,o,Ï‹,u,â€¼,!!,×˜,u,ï®’,S,Ğ§,y,Ò,r,Ä›,e,Ä˜,E,Äº,I,Î›,a,Î¿,o,Ãš,Ú,Å˜,R,Æ¯,U,Å“,œ,ï€­,-,â€”,—,à¸«,n,à¸ª,a,à¸,s,Î¨,Y,áºª,A,Ï€,n,Å…,N,Ø!,o,Ğ‹,h,á»£,o,Ä‰,c,â—¦,·,ï®,S,Å²,U,Ğ•,E,Ğ…,S,Ûµ,o,ÙŠ,S,Ø¨,u,Ø©,o,Ø¦,s,Ä¼,l,Ä±,i,Å—,r,Ğ¶,x,Î…,",Ï,w,â–ª,·,Î¶,l,Ğ©,W,à¸¿,B,á»¹,y,ÏŠ,i,Å¥,t,Ğ¿,n,Â´,´,Ú©,s,ï±¢,*,Î¾,E,Ñœ,k,âˆš,v,Ï„,t,Ã,Ğ,Â£,£,Ã±,ñ,Â¥,¥,Ã«,ë,Ã¥,å,ï™,Y,Ç,a)
  %r = $replace(%r,áº±,a,â€‚, ,ÎŸ,O,â‚ª,n,áº¬,A,ï‚£,£,ïƒ ,à,ï‚®,®,ïƒ¡,á,ï‚©,©,ïƒµ,õ,á»,o,â€, ,Ö±,¸,Ö¾,-,ï¬´,n,Åº,z,â€Œ, ,Ù,',à¹˜,c,à¸…,m,Â,,ï€¼,<,â–¼,v,ï»œ,S,â„®,e,Åº,z,áº­,a,à¹‘,a,ï¬,fi,ÑŒ,b,ïº’,.,ïºœ,:,à¸¨,a,à¸ ,n,à¹,o,à¸°,=,ï­†,y,à¸‹,i,â€¾,¯,âˆ‚,a,ï¼š,:,â‰ ,=,ï€«,+,Ù…,r,á»“,o,á»¬,U,Ğ›,N,Ó’,A,á»Œ,O,áº„,W,á»´,Y,ïºš,u,ïº¬,i,ïº,u,Å»,Z,ï®•,S,ïº³,w,ï¯½,u,ïº±,uw,ï»š,J,ïº”,a,ï€¡,!,á»…,e,Ù„,J,Ø±,j,Ù€,_,ÏŒ,o,â‚«,d,â„–,no,á»¯,u,Äš,E,Ï†,o,ï» ,I,Ñ†,u,ïƒ…,A,ïƒ‘,N,ĞŠ,H,Îˆ,E,ï¾,~,ï•,U,áº¡,a,ï€±,1,ï€´,4,ï€³,3,á»‰,i,Î•,E,Ğ,U,Ùƒ,J,â˜…,*,ï¢,b,ï€£,$chr(35),ï€¤,$,â—‹,o,Ñ,10,á»µ,y,áº,w,Ò›,k,Ù¿,u,â™‚,o,ï­Š,n,Ù¥,o,ï®,S,â¿,n,ï»—,9,ï¢,b,ï€£,$chr(35),ï€¤,$,â—‹,o,Ñ,10,á»‹,i,Î‘,A,â€€, ,ï»©,o,ï»,E,Ù†,u,áº½,e,Ø«,u,ã…“,t,Ó›,e,Ó˜,E,ï»˜,o,Û·,v,ï¬ª,w,á»¥,u,Å,O,Â,,á»±,u,ï¼ª,J,ï½…,e,ï½,a,ï¼®,N,ï¼ˆ,$chr(40),ï¼ ,@,ï½€,`,ï¼,.,â€²,',ï¼‰,$chr(41),â–¬,-,â—„,<,â–º,>,âˆ‘,E,Ö»,$chr(44),â€¬,|,â€,|,â€ª,|,â€«,|,á»˜,O,Ğ˜,N,ï—,W,ïº,z)
  %r = $replace(%r,×¡,o,â•³,X,Ù ,·,Ò’,F,Ï…,u,â€,,Ö¼,·,Ç”,u,à¸œ,w,áº°,A,áº¤,A,Â»,»,ïº–,u,á»‘,o,ï®“,S,á»Ÿ,o,ïº•,u,ï®”,S, Òœ,K,â™¦,·,â€—,_,ï»ˆ,b,à¸¬,w,ï¬°,x,ï‚­,-,à¸‚,u,à¸—,n,á»œ,O,áº¶,A,á»­,u,á»„,E,à¨¹,J, Ù‡,o,â– ,·,Æ¡,o,ï¿,,Ò£,h,Òš,K,Ò²,X,Ò³,x,Òœ,K,Ø¹,E,Ú†,c,Ñ‡,y,Ğ¥,X,Ù¦,7,Ö½,.,Ù,',Ö¿,',×ƒ,:,á»,o,Ò–,X,ÛŒ,s,à¸¬,w,âˆ™,·,Î¤,T,â“’,c,â“,a,â“Ÿ,p,â“”,e,â“£,t,Ç,A,Ğ¥,X,Ö³,.,ÛŒ,s,á»ˆ,I,Ì‰,',ïš,Z,á»,o,áº¹,e,Ò,k,ïº–,u,á»‘,o,ï®“,S,á»Ÿ,o,ïº•,u,Òš,K,ïš,Z,Ì•,',â”œ,|,â”¤,|,Ø£,I,Â‹,,×,x,áº·,a,Ç’,o,á»œ,O,â˜¼,¤,×,.,ïš,Z,à¸¤,n,â‘·,4,â‘µ,2,â’ª,0,à¹€,i)
  return %r
}
